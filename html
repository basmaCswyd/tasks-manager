<!DOCTYPE html>
<html lang="en" data-theme="light"> <!-- Default theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serene Task Planner</title>

    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ====================================================== */
        /* === CSS STYLES START ================================ */
        /* ====================================================== */

        /* === CSS Custom Properties (Variables) - Brown & Soft Purple Theme === */
        :root { /* Light Theme */
            --bg-primary: #fdfaf6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f5f2;
            --bg-accent: #ede9f7;
            --bg-overlay: rgba(92, 83, 73, 0.7);
            --text-primary: #5c5349;
            --text-secondary: #8d7b68;
            --text-tertiary: #ab9a89;
            --text-on-accent: #a491d3;
            --text-on-primary-action: #ffffff;
            --text-link: var(--action-primary);
            --border-primary: #e5e0da;
            --border-secondary: #d4ccc3;
            --border-accent: #c7bddb;
            --action-primary: #9c7a54;
            --action-primary-hover: #8a6d4b;
            --action-primary-active: #785f42;
            --action-secondary: #f8f5f2;
            --action-secondary-hover: #e5e0da;
            --shadow-soft: rgba(92, 83, 73, 0.08);
            --shadow-medium: rgba(92, 83, 73, 0.12);
            --shadow-focus: rgba(156, 122, 84, 0.3);
            --shadow-primary-action: rgba(156, 122, 84, 0.25);
            --priority-high: #d9534f;
            --priority-medium: #9c7a54;
            --priority-low: #a491d3;
            --timer-work: var(--action-primary);
            --timer-break: var(--priority-low);
            --pomodoro-indicator-color: #ab9a89;
            --category-border-work: #9c7a54;
            --category-border-personal: #a491d3;
            --category-border-health: #d9534f;
            --category-border-learning: #4c6ef5;
            --category-border-other: #adb5bd;
            --input-padding: 11px 13px;
            --input-font-size: 0.95em;
            --border-radius: 4px;
        }

        [data-theme="dark"] { /* Dark Theme */
            --bg-primary: #1a1a1a; --bg-secondary: #252525; --bg-tertiary: #333333;
            --bg-accent: #4a3d50; --bg-overlay: rgba(0, 0, 0, 0.8);
            --text-primary: #e8e6e3; --text-secondary: #b0a8a0; --text-tertiary: #8d7b68;
            --text-on-accent: #e8e6e3; --text-on-primary-action: #ffffff; --text-link: #b8a6e0;
            --border-primary: #5c5349; --border-secondary: #8d7b68; --border-accent: #a491d3;
            --action-primary: #a491d3; --action-primary-hover: #b8a6e0; --action-primary-active: #9380c4;
            --action-secondary: #333333; --action-secondary-hover: #444444;
            --shadow-soft: rgba(0, 0, 0, 0.3); --shadow-medium: rgba(0, 0, 0, 0.4);
            --shadow-focus: rgba(164, 145, 211, 0.4); --shadow-primary-action: rgba(164, 145, 211, 0.3);
            --priority-high: #ff7b72; --priority-medium: #c5a983; --priority-low: #b8a6e0;
            --timer-work: var(--priority-medium); --timer-break: var(--priority-low);
            --pomodoro-indicator-color: var(--text-tertiary);
            --category-border-work: var(--priority-medium); --category-border-personal: var(--priority-low);
            --category-border-health: var(--priority-high); --category-border-learning: #74c0fc;
            --category-border-other: var(--text-tertiary);
        }

        /* === Global Reset & Base === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: var(--bg-primary); color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* === Section Styling === */
        .scroll-section { min-height: 100vh; height: 100vh; scroll-snap-align: start; display: flex; flex-direction: column; padding: 30px 40px; overflow: hidden; position: relative; border-bottom: 1px solid var(--border-primary); }
        .scroll-section:last-child { border-bottom: none; }
        .content-wrapper { flex-grow: 1; overflow-y: auto; padding-bottom: 30px; -ms-overflow-style: none; scrollbar-width: none; }
        .content-wrapper::-webkit-scrollbar { display: none; }

        /* === Section Content Animation === */
        .container-inner {
            width: 100%; max-width: 1050px; margin: 0 auto; display: flex; flex-direction: column;
            /* Apply animation directly when section snaps */
            animation: contentFadeIn 0.6s ease-out 0.1s backwards; /* Delay start slightly */
        }
        @keyframes contentFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Apply slight delay to intro elements as well */
        #intro-section h1 { animation: contentFadeIn 0.6s ease-out 0.1s backwards; }
        #intro-section p { animation: contentFadeIn 0.6s ease-out 0.2s backwards; }
        #intro-section .scroll-down-hint { animation: bounce 2s infinite ease-in-out, contentFadeIn 0.6s ease-out 0.3s backwards; }


        /* Specific Section Styles */
        #intro-section { justify-content: center; align-items: center; text-align: center; background-color: var(--bg-primary); }
        #intro-section h1 { font-size: 2.8em; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; }
        #intro-section p { font-size: 1.1em; color: var(--text-secondary); max-width: 600px; line-height: 1.7; margin-bottom: 30px; }
        #intro-section .scroll-down-hint { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 1.8em; color: var(--text-tertiary); }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); } 40% { transform: translateX(-50%) translateY(-10px); } 60% { transform: translateX(-50%) translateY(-5px); } }
        #intro-section #themeToggleButton { position: absolute; top: 20px; right: 20px; }

        #planner-section { justify-content: flex-start; align-items: stretch; background-color: var(--bg-secondary); }
        #tasks-view-section { justify-content: flex-start; align-items: stretch; background-color: var(--bg-tertiary); }
        #widgets-section-container { background-color: var(--bg-primary); justify-content: flex-start; align-items: stretch; }

        .section-title { text-align: center; margin-bottom: 25px; color: var(--text-secondary); font-weight: 500; font-size: 1.4em; padding-top: 10px; }

        /* === Header & Theme Toggle === */
        #themeToggleButton { background-color: var(--action-secondary); color: var(--text-secondary); border: 1px solid var(--border-secondary); padding: 8px 10px; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; transition: all 0.2s ease; line-height: 1; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;}
        #themeToggleButton:hover { background-color: var(--action-secondary-hover); border-color: var(--text-tertiary); color: var(--text-primary); transform: translateY(-1px); }
        button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { outline: 2px solid var(--action-primary); outline-offset: 2px; box-shadow: none; border-radius: var(--border-radius); }
        #themeToggleButton:focus-visible { border-radius: var(--border-radius); }


        /* === Calendar Controls & Table === */
        .calendar-controls {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 0; border-bottom: none;}
        .calendar-controls button { background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-secondary); padding: 8px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease;}
        .calendar-controls button:hover { background-color: var(--action-secondary-hover); border-color: var(--text-tertiary); color: var(--text-primary); transform: translateY(-1px); }
        #monthYearDisplay {font-size: 1.3em; font-weight: 500; color: var(--text-primary);}
        .calendar-table {width: 100%; border-collapse: separate; border-spacing: 1px; table-layout: fixed; margin-bottom: 0; background-color: var(--border-primary); border-radius: var(--border-radius); overflow: hidden;}
        .calendar-table th {background-color: var(--bg-tertiary); color: var(--text-tertiary); padding: 10px 8px; text-align: center; font-weight: 500; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.4px; border: none;}
        .calendar-table td {background-color: var(--bg-secondary); padding: 6px; text-align: left; vertical-align: top; height: 110px; position: relative; cursor: pointer; transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease; border: none;}
        .calendar-table td:hover:not(.other-month) {background-color: var(--bg-primary); z-index: 10; box-shadow: 0 2px 8px var(--shadow-medium);}
        .calendar-table td.other-month {background-color: var(--bg-tertiary); cursor: default; opacity: 0.7;}
        .calendar-table td.other-month .day-number {color: var(--text-tertiary);}
        .calendar-table td .day-number {font-weight: 500; font-size: 0.85em; padding: 4px 6px; border-radius: var(--border-radius); display: inline-block; color: var(--text-secondary); margin-bottom: 4px; transition: background-color 0.2s ease, color 0.2s ease;}
        .calendar-table td.today .day-number {background-color: var(--action-primary); color: var(--text-on-primary-action); font-weight: 600;}
        .calendar-table td.selected {background-color: var(--bg-accent) !important; box-shadow: inset 0 0 0 2px var(--action-primary); z-index: 5;}
        .calendar-table td.selected .day-number {color: var(--action-primary); font-weight: 600;}
        .day-cell::after {content: ''; position: absolute; bottom: 6px; right: 6px; width: 8px; height: 8px; border-radius: 50%; background-color: transparent; opacity: 0; transform: scale(0.5); transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.3s ease;}
        .day-cell.green::after {background-color: var(--priority-low); opacity: 1; transform: scale(1);}
        .day-cell.yellow::after {background-color: var(--priority-medium); opacity: 1; transform: scale(1);}
        .day-cell.red::after {background-color: var(--priority-high); opacity: 1; transform: scale(1);}

        /* === Tasks Display & List === */
        #tasks-view-section .tasks-display {margin-top: 0; padding: 0; background-color: transparent; border-radius: 0; border: none; box-shadow: none;}
        #tasks-view-section .tasks-display-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-primary);}
        #tasks-view-section .tasks-display-header h3 {margin: 0; color: var(--text-primary); font-size: 1.2em; font-weight: 600;}
        #tasks-view-section #addNewTaskBtn {background-color: var(--action-primary); color: var(--text-on-primary-action); border: none; padding: 8px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 1px 2px var(--shadow-primary-action);}
        #tasks-view-section #addNewTaskBtn:hover {background-color: var(--action-primary-hover); transform: translateY(-1px); box-shadow: 0 2px 4px var(--shadow-primary-action);}
        .tasks-list {list-style-type: none; padding: 0; margin-bottom: 0;}
        .tasks-list li {padding: 10px 12px; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-left-width: 4px; border-left-color: transparent; border-radius: var(--border-radius); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; font-size: 0.95em; box-shadow: 0 1px 2px var(--shadow-soft); animation: taskListItemFadeIn 0.4s ease-out forwards; opacity: 0;} /* Fade in list items */
        @keyframes taskListItemFadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .tasks-list li:hover {border-color: var(--border-secondary); border-left-color: inherit; transform: translateY(-1px); box-shadow: 0 2px 5px var(--shadow-medium); z-index: 1;}
        .tasks-list li.pomodoro-active-task { border-left-color: var(--timer-work) !important; background-color: var(--bg-accent); }
        .tasks-list li.category-work { border-left-color: var(--category-border-work); } .tasks-list li.category-personal { border-left-color: var(--category-border-personal); } .tasks-list li.category-health { border-left-color: var(--category-border-health); } .tasks-list li.category-learning { border-left-color: var(--category-border-learning); } .tasks-list li.category-other { border-left-color: var(--category-border-other); }
        .task-category-display {font-size: 0.75em; color: var(--text-tertiary); margin-left: 6px; text-transform: capitalize; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; background-color: var(--bg-tertiary); padding: 1px 4px; border-radius: 2px;}
        .task-item-main { display: flex; align-items: center; flex-grow: 1; }
        .priority-indicator {width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0;}
        .priority-high {background-color: var(--priority-high);} .priority-medium {background-color: var(--priority-medium);} .priority-low {background-color: var(--priority-low);}
        .task-text-and-pomodoros { display: flex; flex-direction: column; flex-grow: 1; }
        .tasks-list li .task-text {color: var(--text-primary); margin-right: 10px; }
        .tasks-list li.done .task-text {text-decoration: line-through; color: var(--text-tertiary); opacity: 0.7;}
        .pomodoro-counts { display: flex; margin-top: 3px; align-items: center; }
        .pomodoro-count-dot {width: 7px; height: 7px; border-radius: 50%; background-color: var(--pomodoro-indicator-color); margin-right: 3px; opacity: 0.6;}
        .task-actions { display: flex; align-items: center; flex-shrink: 0; margin-left: auto; }
        .task-actions button {background-color: var(--bg-secondary); color: var(--text-tertiary); border: 1px solid var(--border-secondary); padding: 5px; font-size: 0.85em; border-radius: var(--border-radius); cursor: pointer; margin-left: 4px; font-weight: 500; transition: all 0.2s ease; line-height: 1; min-width: 30px; text-align: center;}
        .task-actions button:hover {color: var(--text-primary); background-color: var(--action-secondary-hover); border-color: var(--border-secondary); transform: scale(1.05);}
        .task-actions .start-pomodoro-btn { font-size: 1em; padding: 5px;}
        .task-actions .action-icon { width: 1em; height: 1em; }

        /* === Modal === */
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--bg-overlay); align-items: center; justify-content: center; animation: modalFadeIn 0.2s ease-out forwards;}
        .modal-content {background-color: var(--bg-secondary); margin: auto; padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 460px; box-shadow: 0 8px 25px var(--shadow-medium); position: relative; animation: modalSlideInUp 0.25s ease-out forwards; border: 1px solid var(--border-primary);}
        .modal-header {display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; margin-bottom: 20px; border-bottom: 1px solid var(--border-primary);}
        .modal-header h3 {margin: 0; font-size: 1.2em; color: var(--text-primary); font-weight: 600;}
        .close-button {color: var(--text-tertiary); font-size: 24px; font-weight: normal; cursor: pointer; padding: 0 5px; line-height: 1; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease, color 0.2s ease;}
        .close-button:hover {background-color: var(--action-secondary-hover); color: var(--text-primary);}
        .modal-form-group {margin-bottom: 18px;}
        .modal-form-group label {display: block; font-size: 0.9em; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500;}
        #modalTaskInput, #modalTaskPriority, #modalTaskCategory {width: 100%; padding: var(--input-padding); border: 1px solid var(--border-secondary); border-radius: var(--border-radius); font-size: var(--input-font-size); color: var(--text-primary); background-color: var(--bg-secondary); transition: border-color 0.2s ease, box-shadow 0.2s ease;}
        #modalSaveTaskBtn {background-color: var(--action-primary); color: var(--text-on-primary-action); border: none; padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 500; width: 100%; transition: all 0.2s ease; box-shadow: 0 1px 3px var(--shadow-primary-action);}
        #modalSaveTaskBtn:hover {background-color: var(--action-primary-hover); transform: translateY(-1px); box-shadow: 0 2px 5px var(--shadow-primary-action);}
        #noTasksMessage {text-align:center; color: var(--text-tertiary); padding: 30px 0; font-size: 0.95em;}

        /* === Widget Section (Responsive Grid) === */
        .widgets-section {display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px;}
        @media (min-width: 768px) { .widgets-section { grid-template-columns: repeat(2, 1fr); } }

        .widget {padding: 18px; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--border-radius); box-shadow: 0 1px 4px var(--shadow-soft); display: flex; flex-direction: column;}
        .widget h4 {font-size: 1em; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .widget h4 .widget-icon {font-size: 0.9em; color: var(--text-secondary);}

        /* Specific Widget Styles */
        .daily-summary-widget .summary-item {display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.9em; border-bottom: 1px dashed var(--border-secondary);} .daily-summary-widget .summary-item:last-child { border-bottom: none; } .daily-summary-widget .summary-label { color: var(--text-secondary); } .daily-summary-widget .summary-value { font-weight: 600; color: var(--text-primary); } .daily-summary-widget .summary-value.percentage { color: var(--action-primary); } .daily-summary-widget #upcomingTasksValue.high-load { color: var(--priority-high); font-weight: 700; }
        .inspiration-widget {background-color: var(--bg-tertiary); border-color: var(--border-primary);} .inspiration-widget h4 {color: var(--text-primary); border-color: var(--border-primary);} .inspiration-widget #quoteText {font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; font-style: italic; min-height: 3em; display: flex; align-items: center; justify-content: center;} .inspiration-widget #quoteAuthor {font-size: 0.8em; color: var(--text-tertiary); margin-bottom: 15px; display: block;} .inspiration-widget #newSparkBtn {background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-secondary); padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.2s ease;} .inspiration-widget #newSparkBtn:hover {background-color: var(--action-secondary-hover); color: var(--text-primary); border-color: var(--text-tertiary); transform: translateY(-1px);}
        .quick-notes-widget textarea {width: 100%; min-height: 110px; padding: 10px; border: 1px solid var(--border-secondary); border-radius: var(--border-radius); font-size: 0.9em; background-color: var(--bg-secondary); color: var(--text-primary); resize: vertical; margin-bottom: 10px; line-height: 1.4; flex-grow: 1;} .quick-notes-widget .notes-actions {text-align: right;} .quick-notes-widget #clearNotesBtn {background-color: var(--action-secondary); color: var(--text-tertiary); border: 1px solid var(--border-secondary); padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.85em; transition: all 0.2s ease;} .quick-notes-widget #clearNotesBtn:hover {background-color: var(--action-secondary-hover); color: var(--text-primary); border-color: var(--text-tertiary);}
        .pomodoro-widget {text-align: center;} .pomodoro-widget #pomodoroActiveTask {font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px; font-style: italic; min-height: 1.2em;} .pomodoro-widget #pomodoroTimeDisplay {font-size: 2.8em; font-weight: 600; margin-bottom: 15px; color: var(--timer-work); transition: color 0.3s ease;} .pomodoro-widget #pomodoroTimeDisplay.break-time {color: var(--timer-break);} .pomodoro-widget .timer-controls button {background-color: var(--action-secondary); color: var(--text-secondary); border: 1px solid var(--border-secondary); padding: 8px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; margin: 0 5px; transition: all 0.2s ease;} .pomodoro-widget .timer-controls button:hover {background-color: var(--action-secondary-hover); color: var(--text-primary); transform: translateY(-1px);} .pomodoro-widget #pomodoroStatus {font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px; font-style: italic;}

        /* === Footer Utilities === */
        .footer-utilities {margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-primary); font-size: 0.85em; color: var(--text-tertiary); display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;}
        .keyboard-shortcuts details { cursor: pointer; } .keyboard-shortcuts summary { font-weight: 500; display: inline-block; color: var(--text-secondary);} .keyboard-shortcuts ul { list-style: none; padding-left: 0; margin-top: 8px; } .keyboard-shortcuts li { margin-bottom: 4px; } .keyboard-shortcuts kbd { display: inline-block; background-color: var(--bg-tertiary); border: 1px solid var(--border-secondary); padding: 2px 6px; border-radius: var(--border-radius); font-family: monospace; font-size: 0.9em; box-shadow: inset 0 -1px 0 var(--border-secondary); margin-right: 6px; color: var(--text-secondary);}
        #clearAllDataBtn { background-color: transparent; color: var(--priority-high); border: 1px solid var(--priority-high); padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.2s ease;}
        #clearAllDataBtn:hover { background-color: var(--priority-high); color: white; } #clearAllDataBtn .fa-trash-can { margin-right: 5px; }

        /* Animations */
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideInUp { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    </style>
</head>
<body>

    <!-- Section 1: Introduction -->
    <section id="intro-section" class="scroll-section">
        <!-- No content wrapper needed here -->
        <h1>Serene Task Planner</h1>
        <p>
            Organize your day, focus your work, and achieve your goals with clarity.
            Scroll down to plan your tasks and use the productivity tools.
        </p>
        <div class="scroll-down-hint">
             <i class="fa-solid fa-angles-down"></i>
        </div>
         <button id="themeToggleButton" title="Toggle Theme (T)">
            <!-- Icon managed by JS -->
        </button>
    </section>

    <!-- Section 2: Calendar -->
    <section id="planner-section" class="scroll-section">
        <div class="content-wrapper">
            <div class="container-inner">
                 <h2 class="section-title"><i class="fa-regular fa-calendar-days"></i> Calendar</h2>
                <div class="calendar-controls">
                    <button id="prevMonthBtn" title="Previous Month"><i class="fa-solid fa-chevron-left"></i> Prev</button>
                    <span id="monthYearDisplay"></span>
                    <button id="nextMonthBtn" title="Next Month">Next <i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <table class="calendar-table">
                    <thead><tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr></thead>
                    <tbody id="calendarBody"></tbody>
                </table>
                 <div class="scroll-down-hint" style="position: relative; bottom: 5px; transform: none; left: auto; font-size: 1em; text-align: center;">
                     Scroll for Tasks <i class="fa-solid fa-angles-down fa-xs"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 3: Tasks -->
    <section id="tasks-view-section" class="scroll-section">
         <div class="content-wrapper">
            <div class="container-inner">
                 <h2 class="section-title"><i class="fa-regular fa-rectangle-list"></i> Tasks for Selected Day</h2>
                <div class="tasks-display" id="tasksDisplay">
                    <div class="tasks-display-header">
                        <h3 id="selectedDayTitle">Tasks</h3>
                        <button id="addNewTaskBtn" title="Add New Task (A)">
                             <i class="fa-solid fa-plus"></i> Add Task
                        </button>
                    </div>
                    <ul class="tasks-list" id="tasksList"></ul>
                    <p id="noTasksMessage" style="display:none;">No tasks scheduled for this day.</p>
                </div>
                 <div class="scroll-down-hint" style="position: relative; bottom: 5px; transform: none; left: auto; font-size: 1em; text-align: center; margin-top: auto; padding-top: 10px;">
                     Scroll for Tools <i class="fa-solid fa-angles-down fa-xs"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 4: Widgets & Utilities -->
    <section id="widgets-section-container" class="scroll-section">
        <div class="content-wrapper">
            <div class="container-inner">
                 <h2 class="section-title">Tools & Insights</h2>
                <div class="widgets-section">
                     <div class="widget daily-summary-widget">
                        <h4><i class="fa-regular fa-calendar-check widget-icon"></i> Daily Snapshot</h4>
                        <div class="summary-item"><span class="summary-label">Total Tasks:</span><span id="totalTasksToday" class="summary-value">0</span></div>
                        <div class="summary-item"><span class="summary-label">Completed:</span><span id="completedTasksToday" class="summary-value">0</span></div>
                        <div class="summary-item"><span class="summary-label">Rate:</span><span id="completionRateToday" class="summary-value percentage">0%</span></div>
                        <div class="summary-item"><span class="summary-label">Next 7 Days:</span><span id="upcomingTasksValue" class="summary-value">0</span></div>
                    </div>
                    <div class="widget inspiration-widget">
                         <h4><i class="fa-regular fa-lightbulb widget-icon"></i> Daily Spark</h4>
                        <p id="quoteText">Loading inspiration...</p>
                        <small id="quoteAuthor"></small>
                        <button id="newSparkBtn">New Spark</button>
                    </div>
                    <div class="widget quick-notes-widget">
                         <h4><i class="fa-regular fa-note-sticky widget-icon"></i> Quick Notes</h4>
                        <textarea id="quickNotesArea" placeholder="Jot down quick thoughts..."></textarea>
                        <div class="notes-actions"><button id="clearNotesBtn">Clear</button></div>
                    </div>
                    <div class="widget pomodoro-widget">
                        <h4><i class="fa-regular fa-clock widget-icon"></i> Focus Timer</h4>
                        <p id="pomodoroActiveTask">Focusing on: ---</p>
                        <div id="pomodoroTimeDisplay">25:00</div>
                        <div class="timer-controls">
                            <button id="pomodoroStartPauseBtn" title="Start/Pause Timer (P)"><i class="fa-solid fa-play"></i> Start</button>
                            <button id="pomodoroResetBtn" title="Reset Timer (R)"><i class="fa-solid fa-arrow-rotate-left"></i> Reset</button>
                        </div>
                        <p id="pomodoroStatus">Ready to focus?</p>
                    </div>
                </div>
                 <div class="footer-utilities">
                    <div class="keyboard-shortcuts">
                         <details>
                            <summary title="Show/Hide Keyboard Shortcuts">Keyboard Shortcuts</summary>
                            <ul>
                                <li><kbd>A</kbd> Add New Task</li>
                                <li><kbd>T</kbd> Toggle Theme</li>
                                <li><kbd>P</kbd> Start/Pause Timer</li>
                                <li><kbd>R</kbd> Reset Timer</li>
                                <li><kbd>Esc</kbd> Close Modal</li>
                            </ul>
                        </details>
                    </div>
                    <button id="clearAllDataBtn" title="Warning: Deletes all tasks, notes, and settings!">
                        <i class="fa-solid fa-trash-can"></i> Clear All Data
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
       <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Task</h3>
                <span class="close-button" id="closeModalBtn">×</span>
            </div>
            <div class="modal-form-group">
                <label for="modalTaskInput">Task Description:</label>
                <input type="text" id="modalTaskInput" placeholder="What needs to be done?">
            </div>
            <div class="modal-form-group">
                <label for="modalTaskPriority">Priority:</label>
                <select id="modalTaskPriority">
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label for="modalTaskCategory">Category:</label>
                <input type="text" id="modalTaskCategory" placeholder="e.g., Work, Study (optional)">
            </div>
            <input type="hidden" id="modalEditingTaskId">
            <button id="modalSaveTaskBtn">Save Task</button>
        </div>
    </div>
    <audio id="pomodoroAlertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

    <script>
        // --- CONFIGURATION ---
        const DEFAULT_POMODORO_WORK_MINS = 25; const DEFAULT_POMODORO_SHORT_BREAK_MINS = 5; const DEFAULT_POMODORO_LONG_BREAK_MINS = 15;

        // --- GLOBAL STATE & CONSTANTS ---
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; let currentDate = new Date(); let tasks = {}; let selectedDateString = null; const inspirationalQuotes = [ { text: "The secret of getting ahead is getting started.", author: "Mark Twain" }, { text: "It’s not the load that breaks you down, it’s the way you carry it.", author: "Lou Holtz" }, { text: "The best way to predict the future is to create it.", author: "Peter Drucker" }, { text: "Well done is better than well said.", author: "Benjamin Franklin" } ]; let lastQuoteIndex = -1; let notesSaveTimeout; let pomodoroInterval; let pomodoroTimeLeft = DEFAULT_POMODORO_WORK_MINS * 60; let pomodoroIsRunning = false; let pomodoroCurrentSession = 'work'; let pomodoroCycles = 0; let activePomodoroTaskId = null; const POMODORO_SESSIONS = { work: DEFAULT_POMODORO_WORK_MINS * 60, shortBreak: DEFAULT_POMODORO_SHORT_BREAK_MINS * 60, longBreak: DEFAULT_POMODORO_LONG_BREAK_MINS * 60 };

        // --- DOM Elements ---
        const calendarBody = document.getElementById('calendarBody'); const monthYearDisplay = document.getElementById('monthYearDisplay'); const prevMonthBtn = document.getElementById('prevMonthBtn'); const nextMonthBtn = document.getElementById('nextMonthBtn'); const tasksDisplaySection = document.getElementById('tasksDisplay'); const selectedDayTitle = document.getElementById('selectedDayTitle'); const tasksList = document.getElementById('tasksList'); const addNewTaskBtn = document.getElementById('addNewTaskBtn'); const noTasksMessage = document.getElementById('noTasksMessage'); const taskModal = document.getElementById('taskModal'); const modalTitle = document.getElementById('modalTitle'); const closeModalBtn = document.getElementById('closeModalBtn'); const modalTaskInput = document.getElementById('modalTaskInput'); const modalTaskPriority = document.getElementById('modalTaskPriority'); const modalEditingTaskIdInput = document.getElementById('modalEditingTaskId'); const modalSaveTaskBtn = document.getElementById('modalSaveTaskBtn'); const quoteTextElement = document.getElementById('quoteText'); const quoteAuthorElement = document.getElementById('quoteAuthor'); const newSparkBtn = document.getElementById('newSparkBtn'); const themeToggleButton = document.getElementById('themeToggleButton'); const quickNotesArea = document.getElementById('quickNotesArea'); const clearNotesBtn = document.getElementById('clearNotesBtn'); const pomodoroTimeDisplay = document.getElementById('pomodoroTimeDisplay'); const pomodoroStartPauseBtn = document.getElementById('pomodoroStartPauseBtn'); const pomodoroResetBtn = document.getElementById('pomodoroResetBtn'); const pomodoroStatus = document.getElementById('pomodoroStatus'); const pomodoroAlertSound = document.getElementById('pomodoroAlertSound'); const pomodoroActiveTaskDisplay = document.getElementById('pomodoroActiveTask'); const modalTaskCategory = document.getElementById('modalTaskCategory');
        const totalTasksTodayEl = document.getElementById('totalTasksToday'); const completedTasksTodayEl = document.getElementById('completedTasksToday'); const completionRateTodayEl = document.getElementById('completionRateToday'); const upcomingTasksValueEl = document.getElementById('upcomingTasksValue');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');

        // --- THEME MANAGEMENT ---
        function setInitialTheme() { const savedTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', savedTheme); themeToggleButton.innerHTML = savedTheme === 'light' ? '<i class="fa-regular fa-moon"></i>' : '<i class="fa-regular fa-sun"></i>'; themeToggleButton.title = `Switch to ${savedTheme === 'light' ? 'Dark' : 'Light'} Mode (T)`; } function toggleTheme() { const currentTheme = document.documentElement.getAttribute('data-theme'); const newTheme = currentTheme === 'light' ? 'dark' : 'light'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); themeToggleButton.innerHTML = newTheme === 'light' ? '<i class="fa-regular fa-moon"></i>' : '<i class="fa-regular fa-sun"></i>'; themeToggleButton.title = `Switch to ${newTheme === 'light' ? 'Dark' : 'Light'} Mode (T)`; }

        // --- WIDGETS (Inspiration, Quick Notes, Pomodoro, Daily Summary) ---
        function displayNewSpark() { let randomIndex; do { randomIndex = Math.floor(Math.random() * inspirationalQuotes.length); } while (inspirationalQuotes.length > 1 && randomIndex === lastQuoteIndex); lastQuoteIndex = randomIndex; const randomQuote = inspirationalQuotes[randomIndex]; quoteTextElement.textContent = `“${randomQuote.text}”`; quoteAuthorElement.textContent = `– ${randomQuote.author}`; }
        function loadQuickNotes() { const savedNotes = localStorage.getItem('quickNotes'); if (savedNotes) quickNotesArea.value = savedNotes; } function saveQuickNotes() { localStorage.setItem('quickNotes', quickNotesArea.value); } function handleNotesInput() { clearTimeout(notesSaveTimeout); notesSaveTimeout = setTimeout(saveQuickNotes, 500); } function clearAllNotes() { if (confirm("Are you sure you want to clear all quick notes?")) { quickNotesArea.value = ''; saveQuickNotes(); } }
        function formatPomodoroTime(seconds) { const minutes = Math.floor(seconds / 60); const remainingSeconds = seconds % 60; return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; } function updatePomodoroDisplay() { pomodoroTimeDisplay.textContent = formatPomodoroTime(pomodoroTimeLeft); const activeTask = activePomodoroTaskId ? findTaskById(activePomodoroTaskId) : null; const taskNameForTitle = activeTask ? ` - ${activeTask.text.substring(0,20)}...` : ''; document.title = `${formatPomodoroTime(pomodoroTimeLeft)}${taskNameForTitle} - ${pomodoroCurrentSession === 'work' ? 'Focus' : 'Break'}`; if (pomodoroCurrentSession === 'work') { pomodoroTimeDisplay.classList.remove('break-time'); pomodoroStatus.textContent = activeTask ? `Focusing!` : "Ready to focus?"; } else { pomodoroTimeDisplay.classList.add('break-time'); pomodoroStatus.textContent = "Break time!"; } pomodoroActiveTaskDisplay.textContent = activeTask ? `Task: ${activeTask.text.substring(0, 30)}${activeTask.text.length > 30 ? '...' : ''}` : 'Focusing on: ---';} function startPomodoroTimer() { pomodoroIsRunning = true; pomodoroStartPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause'; pomodoroInterval = setInterval(() => { pomodoroTimeLeft--; updatePomodoroDisplay(); if (pomodoroTimeLeft <= 0) { clearInterval(pomodoroInterval); try { pomodoroAlertSound.play(); } catch(e){ console.warn("Audio play failed:", e); } if (pomodoroCurrentSession === 'work' && activePomodoroTaskId) { incrementTaskPomodoros(activePomodoroTaskId); } switchPomodoroSession(); } }, 1000); } function pausePomodoroTimer() { pomodoroIsRunning = false; pomodoroStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> Resume'; clearInterval(pomodoroInterval); } function resetPomodoroTimer(sessionType = 'work', keepActiveTask = false) { clearInterval(pomodoroInterval); pomodoroIsRunning = false; pomodoroCurrentSession = sessionType; pomodoroTimeLeft = POMODORO_SESSIONS[pomodoroCurrentSession]; pomodoroStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> Start'; if(sessionType === 'work' && !keepActiveTask) { pomodoroCycles = 0; } if (!keepActiveTask) { setActivePomodoroTask(null); } updatePomodoroDisplay(); document.title = "Advanced Planner"; } function switchPomodoroSession() { if (pomodoroCurrentSession === 'work') { pomodoroCycles++; pomodoroCurrentSession = (pomodoroCycles % 4 === 0) ? 'longBreak' : 'shortBreak'; } else { pomodoroCurrentSession = 'work'; } pomodoroTimeLeft = POMODORO_SESSIONS[pomodoroCurrentSession]; updatePomodoroDisplay(); startPomodoroTimer(); } function setActivePomodoroTask(taskId) { document.querySelectorAll('.tasks-list li.pomodoro-active-task').forEach(el => el.classList.remove('pomodoro-active-task')); activePomodoroTaskId = taskId; if (taskId) { const taskItem = document.querySelector(`.tasks-list li[data-task-id="${taskId}"]`); if (taskItem) { taskItem.classList.add('pomodoro-active-task'); } resetPomodoroTimer('work', true); } else { resetPomodoroTimer('work', false); } updatePomodoroDisplay(); } function findTaskById(taskId) { if (!selectedDateString || !tasks[selectedDateString]) return null; return tasks[selectedDateString].find(t => t.id === taskId); } function incrementTaskPomodoros(taskId) { if (!selectedDateString || !tasks[selectedDateString]) return; const task = findTaskById(taskId); if (task) { task.completedPomodoros = (task.completedPomodoros || 0) + 1; saveTasks(); } }
        function updateDailySummary() { /* ... (same) ... */ if (!selectedDateString) { totalTasksTodayEl.textContent = '-'; completedTasksTodayEl.textContent = '-'; completionRateTodayEl.textContent = '-'; upcomingTasksValueEl.textContent = '-'; upcomingTasksValueEl.classList.remove('high-load'); return; } const todaysTasks = tasks[selectedDateString] || []; const totalToday = todaysTasks.length; const completedToday = todaysTasks.filter(task => task.done).length; const completionRate = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0; totalTasksTodayEl.textContent = totalToday; completedTasksTodayEl.textContent = completedToday; completionRateTodayEl.textContent = `${completionRate}%`; let upcomingCount = 0; let tempDate = new Date(selectedDateString + "T00:00:00"); for (let i = 1; i <= 7; i++) { tempDate.setDate(tempDate.getDate() + 1); const nextDateStr = formatDate(tempDate); upcomingCount += (tasks[nextDateStr] || []).length; } upcomingTasksValueEl.textContent = upcomingCount; upcomingTasksValueEl.classList.toggle('high-load', upcomingCount > 15); }

        // --- LOCAL STORAGE & CORE DATA HANDLING ---
        function loadTasks() { /* ... (same) ... */ const storedTasks = localStorage.getItem('calendarTasks'); if (storedTasks) { const loaded = JSON.parse(storedTasks); for (const dateKey in loaded) { if (Array.isArray(loaded[dateKey])) { loaded[dateKey] = loaded[dateKey].map(task => ({ ...task, priority: task.priority || 'medium', category: task.category || 'other', completedPomodoros: task.completedPomodoros || 0 })); } } tasks = loaded; } }
        function saveTasks() { localStorage.setItem('calendarTasks', JSON.stringify(tasks)); updateDailySummary(); }
        function clearAllData() { if (confirm("⚠️ WARNING! ⚠️\n\nDelete ALL tasks, notes, and settings?\nThis cannot be undone.")) { localStorage.removeItem('calendarTasks'); localStorage.removeItem('quickNotes'); localStorage.removeItem('theme'); localStorage.removeItem('lastSelectedDate'); tasks = {}; activePomodoroTaskId = null; location.reload(); } }

        // --- CALENDAR RENDERING & DATE UTILS ---
        function renderCalendar() { /* ... (same) ... */ calendarBody.innerHTML = ''; const year = currentDate.getFullYear(); const month = currentDate.getMonth(); monthYearDisplay.textContent = `${monthNames[month]} ${year}`; const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0); const daysInMonth = lastDayOfMonth.getDate(); const firstDayOfWeek = firstDayOfMonth.getDay(); let date = 1; for (let i = 0; i < 6; i++) { const row = document.createElement('tr'); for (let j = 0; j < 7; j++) { const cell = document.createElement('td'); cell.classList.add('day-cell'); const dayNumberSpan = document.createElement('span'); dayNumberSpan.classList.add('day-number'); if (i === 0 && j < firstDayOfWeek || date > daysInMonth) { cell.classList.add('other-month'); } else { const cellDate = new Date(year, month, date); const cellDateString = formatDate(cellDate); dayNumberSpan.textContent = date; cell.dataset.date = cellDateString; const today = new Date(); if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { cell.classList.add('today'); } if (cellDateString === selectedDateString) { cell.classList.add('selected'); } cell.addEventListener('click', () => { if (!cell.classList.contains('other-month')) { selectDay(cellDateString, cell); } }); cell.appendChild(dayNumberSpan); updateDayCellColor(cell, cellDateString); date++; } row.appendChild(cell); } calendarBody.appendChild(row); if (date > daysInMonth && i < 5) { let allEmptyInRow = Array.from(row.children).every(c => c.classList.contains('other-month')); if(allEmptyInRow && i >=3) { row.remove(); break; } } } const lastRow = calendarBody.lastElementChild; if (lastRow && calendarBody.children.length > 5) { if (Array.from(lastRow.children).every(c => c.classList.contains('other-month'))) { lastRow.remove(); } } }
        function formatDate(dateObj) { const year = dateObj.getFullYear(); const month = (dateObj.getMonth() + 1).toString().padStart(2, '0'); const day = dateObj.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function updateDayCellColor(cellElement, dateString) { /* ... (same) ... */ if (!cellElement) cellElement = calendarBody.querySelector(`td[data-date="${dateString}"]`); if (!cellElement) return; cellElement.classList.remove('green', 'yellow', 'red'); const dayTasks = tasks[dateString] || []; const dayDate = new Date(dateString + "T00:00:00"); const today = new Date(); today.setHours(0,0,0,0); if (dayDate > today) return; if (dayTasks.length === 0) { cellElement.classList.add('yellow'); return; } const allDone = dayTasks.every(task => task.done); const someDone = dayTasks.some(task => task.done); if (allDone) cellElement.classList.add('green'); else if (someDone) cellElement.classList.add('yellow'); else cellElement.classList.add('red');}

        // --- TASK MANAGEMENT (CRUD + Rendering) ---
        function selectDay(dateString, cellElement) { /* ... (same) ... */ if (activePomodoroTaskId && selectedDateString && selectedDateString !== dateString) { const activeTask = findTaskById(activePomodoroTaskId); if(activeTask) { pausePomodoroTimer(); setActivePomodoroTask(null); console.log("Pomodoro stopped: day changed.");}} const previouslySelectedCells = calendarBody.querySelectorAll('td.selected'); previouslySelectedCells.forEach(pc => pc.classList.remove('selected')); if (cellElement) { cellElement.classList.add('selected'); } else { const currentCellToSelect = calendarBody.querySelector(`td[data-date="${dateString}"]`); if (currentCellToSelect) currentCellToSelect.classList.add('selected'); } selectedDateString = dateString; localStorage.setItem('lastSelectedDate', selectedDateString); const dateObj = new Date(dateString + "T00:00:00"); const today = new Date(); selectedDayTitle.textContent = `Tasks for ${dateString === formatDate(today) ? 'Today' : ''} ${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}${dateString !== formatDate(today) ? ', ' + dateObj.getFullYear() : ''}`; renderTasksForSelectedDay(); }
        function renderTasksForSelectedDay() { /* ... (same) ... */ tasksList.innerHTML = ''; const dayTasks = tasks[selectedDateString] || []; if (dayTasks.length === 0) { noTasksMessage.style.display = 'block'; tasksList.style.display = 'none'; } else { noTasksMessage.style.display = 'none'; tasksList.style.display = 'block'; const priorityOrder = { high: 1, medium: 2, low: 3 }; dayTasks.sort((a, b) => (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3) || a.id - b.id); dayTasks.forEach((task, index) => { const li = document.createElement('li'); li.dataset.taskId = task.id; if (task.done) li.classList.add('done'); if (task.id === activePomodoroTaskId) li.classList.add('pomodoro-active-task'); /* li.style.animationDelay = `${index * 0.05}s`; */ /* Removed stagger for simplicity */ const categoryClass = `category-${(task.category || 'other').toLowerCase().replace(/[^a-z0-9-]/g, '-')}`; li.classList.add(categoryClass); const taskItemMain = document.createElement('div'); taskItemMain.classList.add('task-item-main'); const priorityIndicator = document.createElement('span'); priorityIndicator.classList.add('priority-indicator', `priority-${task.priority || 'medium'}`); taskItemMain.appendChild(priorityIndicator); const taskTextAndPomodoros = document.createElement('div'); taskTextAndPomodoros.classList.add('task-text-and-pomodoros'); const taskTextSpan = document.createElement('span'); taskTextSpan.classList.add('task-text'); taskTextSpan.textContent = task.text; taskTextAndPomodoros.appendChild(taskTextSpan); const pomodoroCountsDiv = document.createElement('div'); pomodoroCountsDiv.classList.add('pomodoro-counts'); for (let i = 0; i < (task.completedPomodoros || 0); i++) { const dot = document.createElement('span'); dot.classList.add('pomodoro-count-dot'); dot.title = `Pomodoro ${i+1}`; pomodoroCountsDiv.appendChild(dot); } if (task.category && task.category.trim() !== '' && task.category.toLowerCase() !== 'other') { const categoryDisplaySpan = document.createElement('span'); categoryDisplaySpan.classList.add('task-category-display'); categoryDisplaySpan.textContent = `(${task.category})`; pomodoroCountsDiv.appendChild(categoryDisplaySpan); } taskTextAndPomodoros.appendChild(pomodoroCountsDiv); taskItemMain.appendChild(taskTextAndPomodoros); li.appendChild(taskItemMain); const actionsDiv = document.createElement('div'); actionsDiv.classList.add('task-actions'); const startPomoBtn = document.createElement('button'); startPomoBtn.classList.add('start-pomodoro-btn'); startPomoBtn.innerHTML = '<i class="fa-solid fa-stopwatch action-icon"></i>'; startPomoBtn.title = 'Start Pomodoro'; startPomoBtn.disabled = task.done; startPomoBtn.onclick = (e) => { e.stopPropagation(); setActivePomodoroTask(task.id); }; actionsDiv.appendChild(startPomoBtn); const toggleBtn = document.createElement('button'); toggleBtn.classList.add('toggle-btn'); toggleBtn.innerHTML = task.done ? '<i class="fa-solid fa-rotate-left action-icon"></i>' : '<i class="fa-solid fa-check action-icon"></i>'; toggleBtn.title = task.done ? 'Mark Undone' : 'Mark Done'; if (task.done) toggleBtn.classList.add('undo-btn'); toggleBtn.onclick = () => toggleTaskDone(task.id); actionsDiv.appendChild(toggleBtn); const editBtn = document.createElement('button'); editBtn.classList.add('edit-btn'); editBtn.innerHTML = '<i class="fa-solid fa-pencil action-icon"></i>'; editBtn.title = 'Edit Task'; editBtn.onclick = () => openTaskModal('edit', task.id, task.text, task.priority, task.category); actionsDiv.appendChild(editBtn); const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-btn'); deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can action-icon"></i>'; deleteBtn.title = 'Delete Task'; deleteBtn.onclick = () => deleteTask(task.id); actionsDiv.appendChild(deleteBtn); li.appendChild(actionsDiv); tasksList.appendChild(li); }); } updateDayCellColor(null, selectedDateString); updateDailySummary(); }
        function toggleTaskDone(taskId) { /* ... (same) ... */ if (!selectedDateString || !tasks[selectedDateString]) return; const task = findTaskById(taskId); if (task) { task.done = !task.done; if (task.done && activePomodoroTaskId === taskId) { pausePomodoroTimer(); setActivePomodoroTask(null); } saveTasks(); renderTasksForSelectedDay(); updateDayCellColor(null, selectedDateString); } }
        function deleteTask(taskId) { /* ... (same) ... */ if (!selectedDateString || !tasks[selectedDateString]) return; if (confirm('Are you sure you want to delete this task?')) { if (activePomodoroTaskId === taskId) { pausePomodoroTimer(); setActivePomodoroTask(null); } tasks[selectedDateString] = tasks[selectedDateString].filter(t => t.id !== taskId); if (tasks[selectedDateString].length === 0) delete tasks[selectedDateString]; saveTasks(); renderTasksForSelectedDay(); } }
        function checkAllDayColors() { /* ... (same) ... */ const today = new Date(); today.setHours(0,0,0,0); document.querySelectorAll('.calendar-table td[data-date]').forEach(cell => { const cellDateString = cell.dataset.date; const cellDate = new Date(cellDateString + "T00:00:00"); if (cellDate <= today) updateDayCellColor(cell, cellDateString); });}
        function openTaskModal(mode = 'add', taskId = null, taskText = '', taskPriority = 'medium', taskCategory = '') { /* ... (same) ... */ modalEditingTaskIdInput.value = taskId ? taskId : ''; modalTaskInput.value = taskText; modalTaskPriority.value = taskPriority || 'medium'; modalTaskCategory.value = taskCategory === 'other' ? '' : taskCategory || ''; modalTitle.textContent = mode === 'edit' ? 'Edit Task' : 'Add New Task'; modalSaveTaskBtn.textContent = mode === 'edit' ? 'Update Task' : 'Save Task'; taskModal.style.display = 'flex'; modalTaskInput.focus(); }
        function closeTaskModal() { /* ... (same) ... */ taskModal.style.display = 'none'; modalTaskInput.value = ''; modalTaskPriority.value = 'medium'; modalTaskCategory.value = ''; modalEditingTaskIdInput.value = ''; }
        function handleSaveTaskFromModal() { /* ... (same) ... */ const taskText = modalTaskInput.value.trim(); const taskPriorityValue = modalTaskPriority.value; let taskCategoryValue = modalTaskCategory.value.trim(); if (!taskCategoryValue) { taskCategoryValue = 'other';} const editingId = modalEditingTaskIdInput.value ? parseInt(modalEditingTaskIdInput.value) : null; if (!taskText) { alert("Task description cannot be empty."); return; } if (!selectedDateString) { alert("No day selected."); return; } if (!tasks[selectedDateString]) tasks[selectedDateString] = []; if (editingId) { const taskIndex = tasks[selectedDateString].findIndex(t => t.id === editingId); if (taskIndex > -1) { tasks[selectedDateString][taskIndex].text = taskText; tasks[selectedDateString][taskIndex].priority = taskPriorityValue; tasks[selectedDateString][taskIndex].category = taskCategoryValue; } } else { tasks[selectedDateString].push({id: Date.now(), text: taskText, done: false, priority: taskPriorityValue, category: taskCategoryValue, completedPomodoros: 0}); } saveTasks(); renderTasksForSelectedDay(); closeTaskModal(); }

        // --- EVENT LISTENERS ---
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); updateDailySummary(); }); nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); updateDailySummary(); }); addNewTaskBtn.addEventListener('click', () => openTaskModal('add')); closeModalBtn.addEventListener('click', closeTaskModal); window.addEventListener('click', (event) => { if (event.target == taskModal) closeTaskModal(); }); modalSaveTaskBtn.addEventListener('click', handleSaveTaskFromModal); newSparkBtn.addEventListener('click', displayNewSpark); themeToggleButton.addEventListener('click', toggleTheme); quickNotesArea.addEventListener('input', handleNotesInput); clearNotesBtn.addEventListener('click', clearAllNotes); pomodoroStartPauseBtn.addEventListener('click', () => { pomodoroIsRunning ? pausePomodoroTimer() : startPomodoroTimer(); }); pomodoroResetBtn.addEventListener('click', () => resetPomodoroTimer(pomodoroCurrentSession, !!activePomodoroTaskId)); clearAllDataBtn.addEventListener('click', clearAllData);
        document.addEventListener('keydown', (e) => { const activeEl = document.activeElement; const isInputFocused = activeEl.tagName === 'INPUT' || activeEl.tagName === 'SELECT' || activeEl.tagName === 'TEXTAREA'; if (taskModal.style.display === 'flex') { if (e.key === 'Escape') closeTaskModal(); } else if (!isInputFocused) { switch (e.key.toLowerCase()) { case 'a': e.preventDefault(); openTaskModal('add'); break; case 't': e.preventDefault(); toggleTheme(); break; case 'p': e.preventDefault(); pomodoroStartPauseBtn.click(); break; case 'r': if (activeEl !== quickNotesArea && activeEl.type !== 'text') { e.preventDefault(); pomodoroResetBtn.click(); } break; } } });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Planner Initializing..."); setInitialTheme(); loadTasks(); loadQuickNotes(); const lastDate = localStorage.getItem('lastSelectedDate'); const todayString = formatDate(new Date()); const dateRegex = /^\d{4}-\d{2}-\d{2}$/; selectedDateString = (lastDate && dateRegex.test(lastDate)) ? lastDate : todayString; renderCalendar(); const initialCell = calendarBody.querySelector(`td[data-date="${selectedDateString}"]`); if(initialCell && !initialCell.classList.contains('other-month')) { selectDay(selectedDateString, initialCell); } else { selectedDateString = todayString; const todayCell = calendarBody.querySelector(`td[data-date="${todayString}"]`); selectDay(todayString, todayCell); } checkAllDayColors(); displayNewSpark(); updatePomodoroDisplay(); console.log("Planner Initialized.");
        });

    </script>
</body>
</html>
